\documentclass[12pt]{article}

\usepackage[utf8]{inputenc}
\usepackage[english, russian]{babel}

% "А вот теперь --- слайды!"
\usepackage{slides}

\usepackage{graphicx}

\def\Person{Шапошников А.А.}
\def\Title{Тесты в hh.sites.common}
\def\FooterTitle{\Title}
\def\SubTitle{Пара идей о том, как можно тестировать приложения frontik}
\input{title.tex}

%% Переносы в презентации смотряся не очень.
\hyphenpenalty 10000
\sloppy


% pygments какие-то стили
\usepackage{fancyvrb}
\usepackage{color}
%%%%%%%%%%%%%%%%%%%%%%%%%%%\usepackage[ascii]{inputenc}

\makeatletter
\def\PY@reset{\let\PY@it=\relax \let\PY@bf=\relax%
    \let\PY@ul=\relax \let\PY@tc=\relax%
    \let\PY@bc=\relax \let\PY@ff=\relax}
\def\PY@tok#1{\csname PY@tok@#1\endcsname}
\def\PY@toks#1+{\ifx\relax#1\empty\else%
    \PY@tok{#1}\expandafter\PY@toks\fi}
\def\PY@do#1{\PY@bc{\PY@tc{\PY@ul{%
    \PY@it{\PY@bf{\PY@ff{#1}}}}}}}
\def\PY#1#2{\PY@reset\PY@toks#1+\relax+\PY@do{#2}}

\def\PY@tok@gd{\def\PY@tc##1{\textcolor[rgb]{0.63,0.00,0.00}{##1}}}
\def\PY@tok@gu{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.50,0.00,0.50}{##1}}}
\def\PY@tok@gt{\def\PY@tc##1{\textcolor[rgb]{0.00,0.25,0.82}{##1}}}
\def\PY@tok@gs{\let\PY@bf=\textbf}
\def\PY@tok@gr{\def\PY@tc##1{\textcolor[rgb]{1.00,0.00,0.00}{##1}}}
\def\PY@tok@cm{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.25,0.50,0.50}{##1}}}
\def\PY@tok@vg{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\def\PY@tok@m{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\def\PY@tok@mh{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\def\PY@tok@go{\def\PY@tc##1{\textcolor[rgb]{0.50,0.50,0.50}{##1}}}
\def\PY@tok@ge{\let\PY@it=\textit}
\def\PY@tok@vc{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\def\PY@tok@il{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\def\PY@tok@cs{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.25,0.50,0.50}{##1}}}
\def\PY@tok@cp{\def\PY@tc##1{\textcolor[rgb]{0.74,0.48,0.00}{##1}}}
\def\PY@tok@gi{\def\PY@tc##1{\textcolor[rgb]{0.00,0.63,0.00}{##1}}}
\def\PY@tok@gh{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,0.50}{##1}}}
\def\PY@tok@ni{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.60,0.60,0.60}{##1}}}
\def\PY@tok@nl{\def\PY@tc##1{\textcolor[rgb]{0.63,0.63,0.00}{##1}}}
\def\PY@tok@nn{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,1.00}{##1}}}
\def\PY@tok@no{\def\PY@tc##1{\textcolor[rgb]{0.53,0.00,0.00}{##1}}}
\def\PY@tok@na{\def\PY@tc##1{\textcolor[rgb]{0.49,0.56,0.16}{##1}}}
\def\PY@tok@nb{\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\def\PY@tok@nc{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,1.00}{##1}}}
\def\PY@tok@nd{\def\PY@tc##1{\textcolor[rgb]{0.67,0.13,1.00}{##1}}}
\def\PY@tok@ne{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.82,0.25,0.23}{##1}}}
\def\PY@tok@nf{\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,1.00}{##1}}}
\def\PY@tok@si{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.73,0.40,0.53}{##1}}}
\def\PY@tok@s2{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\def\PY@tok@vi{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\def\PY@tok@nt{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\def\PY@tok@nv{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\def\PY@tok@s1{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\def\PY@tok@sh{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\def\PY@tok@sc{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\def\PY@tok@sx{\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\def\PY@tok@bp{\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\def\PY@tok@c1{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.25,0.50,0.50}{##1}}}
\def\PY@tok@kc{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\def\PY@tok@c{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.25,0.50,0.50}{##1}}}
\def\PY@tok@mf{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\def\PY@tok@err{\def\PY@bc##1{\fcolorbox[rgb]{1.00,0.00,0.00}{1,1,1}{##1}}}
\def\PY@tok@kd{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\def\PY@tok@ss{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\def\PY@tok@sr{\def\PY@tc##1{\textcolor[rgb]{0.73,0.40,0.53}{##1}}}
\def\PY@tok@mo{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\def\PY@tok@kn{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\def\PY@tok@mi{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\def\PY@tok@gp{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,0.50}{##1}}}
\def\PY@tok@o{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\def\PY@tok@kr{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\def\PY@tok@s{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\def\PY@tok@kp{\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\def\PY@tok@w{\def\PY@tc##1{\textcolor[rgb]{0.73,0.73,0.73}{##1}}}
\def\PY@tok@kt{\def\PY@tc##1{\textcolor[rgb]{0.69,0.00,0.25}{##1}}}
\def\PY@tok@ow{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.67,0.13,1.00}{##1}}}
\def\PY@tok@sb{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\def\PY@tok@k{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\def\PY@tok@se{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.73,0.40,0.13}{##1}}}
\def\PY@tok@sd{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}

\def\PYZbs{\char`\\}
\def\PYZus{\char`\_}
\def\PYZob{\char`\{}
\def\PYZcb{\char`\}}
\def\PYZca{\char`\^}
% for compatibility with earlier versions
\def\PYZat{@}
\def\PYZlb{[}
\def\PYZrb{]}
\makeatother
% /pygments

\begin{document}

\includegraphics{logo.png}
\TitleSlide

\section{Мотивация и цель}
Тестовый фреймворк должен обеспечить возможность тестировать код в hh.sites.common

\section{Требования к тестам}

\begin{enumerate}
\item не должны зависеть от способа их запуска и чего-то требовать от окружения (т.е. unit тесты)
\item должны быть быстрыми
\item должны писаться сравнительно легко
\item должно быть просто перенести и тестировать не только hh.sites.common но и любое приложение/либу, использующую frontik
\item наглядность и читаемость является плюсом
\end{enumerate}

\section{"Встраивающийся" тестовый фреймворк}

\begin{itemize}
\item Приложения frontik ходят в xml-back'и, затем накладывают xsl
\item Такая узкая специализация позволяет встроиться и перехватывать запросы где-то в районе HTTP-слоя и считать, что приложение изолировано.
\item У самого frontik'a модульный дизайн, позволяет встроиться почти где угодно

\end{itemize}

\section{Ключевые решения в ходе разработки}

\begin{itemize}
\item \emph{Сильно} завязан на frontik. Использует настоящий экземпляр frontik c подмененным http-client
\item \emph{Нет} tornado/ioloop, колбэки вызываются явно
\item \emph{Нет} HTTP и сокетов, http-client напрямую ходит к мокам сервисов

\end{itemize}

\section{Моки сервисов}
\small
\begin{Verbatim}[commandchars=\\\{\}]
\PY{k}{class} \PY{n+nc}{SofeaEmployerMock}\PY{p}{(}\PY{n}{ServiceMock}\PY{p}{)}\PY{p}{:}
 \PY{k}{def} \PY{n+nf}{\PYZus{}\PYZus{}init\PYZus{}\PYZus{}}\PY{p}{(}\PY{n+nb+bp}{self}\PY{p}{)}\PY{p}{:}
  \PY{n+nb}{super}\PY{p}{(}\PY{n}{SofeaEmployerMock}\PY{p}{,} \PY{n+nb+bp}{self}\PY{p}{,}\PY{p}{)}\PY{o}{.}\PY{n}{\PYZus{}\PYZus{}init\PYZus{}\PYZus{}}\PY{p}{(}\PY{l+s}{'}\PY{l+s}{serviceHost}\PY{l+s}{'}\PY{p}{)}
 \PY{k}{def} \PY{n+nf}{fetch\PYZus{}request}\PY{p}{(}\PY{n+nb+bp}{self}\PY{p}{,} \PY{n}{req}\PY{p}{,} \PY{n}{callback} \PY{o}{=} \PY{n+nb+bp}{None}\PY{p}{)}\PY{p}{:}
   \PY{k}{if} \PY{l+s}{'}\PY{l+s}{/vacancy/short?lang=RU&id=1}\PY{l+s}{'} \PY{o}{==} \PY{n}{req}\PY{o}{.}\PY{n}{url}\PY{p}{:}
     \PY{k}{return} \PY{l+m+mi}{200}\PY{p}{,} 
       \PY{l+s+sd}{'''<?xml version="1.0" encoding="UTF-8" standalone="yes"?>}
\PY{l+s+sd}{           <vacancies>}
\PY{l+s+sd}{             <vacancy>}
\PY{l+s+sd}{               <vacancyId>1</vacancyId>}
\PY{l+s+sd}{               <name>Merchandizer</name>}
\PY{l+s+sd}{               <company>}
\PY{l+s+sd}{                 <id>63357</id>}
\PY{l+s+sd}{                 <name>PROFPARK, ZAO</name>}
\PY{l+s+sd}{             </vacancy>}
\PY{l+s+sd}{           </vacancies>'''}
\end{Verbatim}

\section{Тесты}

\small
\begin{Verbatim}[commandchars=\\\{\}]
\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{register}\PY{p}{(}\PY{n}{SofeaEmployerMock}\PY{p}{(}\PY{p}{)}\PY{p}{)}
\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{execute\PYZus{}async\PYZus{}method}\PY{p}{(}
    \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{handler}\PY{p}{,} \PY{n}{vacancy\PYZus{}list\PYZus{}page\PYZus{}by\PYZus{}manager}\PY{p}{,} \PY{l+s}{'}\PY{l+s}{3}\PY{l+s}{'}\PY{p}{,} \PY{l+s}{'}\PY{l+s}{1}\PY{l+s}{'}\PY{p}{)}
\PY{n}{doc} \PY{o}{=} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{handler}\PY{o}{.}\PY{n}{doc}\PY{o}{.}\PY{n}{root\PYZus{}node}
\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{assertEqual}\PY{p}{(}
    \PY{n}{doc}\PY{o}{.}\PY{n}{findtext}\PY{p}{(}\PY{l+s}{'}\PY{l+s}{vacancy/vacancyId}\PY{l+s}{'}\PY{p}{)}\PY{p}{,} \PY{l+s}{'}\PY{l+s}{1}\PY{l+s}{'}\PY{p}{)}
\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{assertEqual}\PY{p}{(}
    \PY{n}{doc}\PY{o}{.}\PY{n}{findtext}\PY{p}{(}\PY{l+s}{'}\PY{l+s}{company/id}\PY{l+s}{'}\PY{p}{)}\PY{p}{,} \PY{l+s}{'}\PY{l+s}{63357}\PY{l+s}{'}\PY{p}{)}
\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{assertEqual}\PY{p}{(}
    \PY{n}{doc}\PY{o}{.}\PY{n}{findtext}\PY{p}{(}\PY{l+s}{'}\PY{l+s}{company/name/}\PY{l+s}{'}\PY{p}{)}\PY{p}{,} \PY{l+s}{'}\PY{l+s}{PROFPARK, ZAO}\PY{l+s}{'}\PY{p}{)}
\end{Verbatim}

\verb+vacancy_list_page_by_manager+ - это метод под тестом

\verb+self.register+, \verb+self.handler+, \verb+execute_async_method+ - из суперкласса

\section{Куда можно двигаться дальше}

\begin{enumerate}
\item Отказаться от наивного вручную написанного xml в моках внешних сервисов, не потеряв при этом простоты и наглядности
\item Требуемые доработки:
\begin{itemize}
\item больше документации
\item поддержка \emph{POST}, а заодно \emph{DELETE} и \emph{PUT}
\item поддержка Content-Type \emph{не} XML

\end{itemize}

\end{enumerate}

\end{document}

